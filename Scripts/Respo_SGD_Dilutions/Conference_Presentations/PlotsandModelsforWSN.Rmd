---
title: "Models_Plots_WSN"
author: "Hannah Merges"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning=FALSE, 
                      message=FALSE)
```

```{r, echo=FALSE}
library(segmented)
library(plotrix)
library(gridExtra)
library(LoLinR)
library(lubridate)
library(chron)
library(patchwork)
library(tidyverse)
library(here)
library(PNWColors)
library(ggrepel)
#library(PerformanceAnalytics)
library(reshape2)
library(viridis)
library(car)
library(GGally)
library(corrplot)
library(PNWColors)
library(seacarb)
library(broom)
library(calecopal)
library(ggridges)
library(agricolae)
library(lme4)
library(lmerTest)
library(modelsummary)
library(tidymodels)
library(flextable)
library(performance)
library(agricolae)
library(ggeffects)
library(sjPlot)
library(patchwork)
library(broom)
library(purrr)
library(nlstools)
library(stringr)
library(emmeans)
library(MuMIn)
```


## Loading the data and creating dfs 
```{r}
RespoMeta <- read_csv(here("Data","RespoFiles","Respo_Metadata_SGDDilutions_Cabral_Varari.csv"))
BioData <- read_csv(here("Data","RespoFiles","Fragment_MeasurementSampling_Cabral_Varari.csv"))
Sample_Info <- left_join(RespoMeta, BioData)

RespoR <- read_csv(here("Data","RespoFiles","Respo_R.csv"))
#View(RespoR)

####################
### pH data #########
######################
pHcalib<-read_csv(here("Data","TrisCal_20230614.csv")) #%>% ## tris cal date is listed as a character here - make sure change in Excel file before reading in so it is a date 
pHcalib$TrisCalDate <- mdy(pHcalib$TrisCalDate)
pHcalib <- pHcalib[-c(13,14), ]

#View(pHcalib)

pHData <- read_csv(here("Data", "RespoFiles", "Fragment_MeasurementSampling_Cabral_Varari.csv")) 
pHData$TrisCalDate <- mdy(pHData$TrisCalDate)
pHData <- pHData[-c(294,303,435),]
#pHData <- pHData[,-(14:17)]

#View(pHData) ### if re-running after a bit, either add in code for converting TrisCalDate to a date OR make sure it is a date in the file 

pHSlope<-pHcalib %>%
  #filter(HOBO_Orion =="Orion") %>% # extract only the orion data
  nest_by(TrisCalDate) %>%
  dplyr::mutate(fitpH = list(lm(mVTRis~Ttris, data = data))) %>% # linear regression of mV and temp of the tris
  dplyr::summarise(broom::tidy(fitpH)) %>% # make the output tidy
  select(TrisCalDate, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>% # put slope and intercept in their own column
  right_join(.,pHData) %>% # join with the pH sample data
  mutate(mVTRis = temp_C*Ttris + `(Intercept)`) #%>% 
 #mutate(new_pH = pH(Ex=mV,Etris=mVTRis,S=salinity,T=temp_C)) # calculate pH of the samples using the pH seacarb function - GETTING AN ERRROR ON THIS LAST LINE ######

#### COME BACK AND CHECK LATER ##### ## seems fine as of Jan27th, 2024 

#View(pHSlope)
######### Respo table #############
RespoR2 <- RespoR %>%
  #drop_na(FileID_csv) %>% # drop NAs
  left_join(Sample_Info) %>% # Join the raw respo calculations with the metadata in Sample Info 
  #mutate(Ch.Volume.ml = ifelse(is.na(volume_ml),ch.vol,ch.vol-volume_ml)) %>% # add 6 L for volume of all blanks and subtract org volume from chamber vol for all else
  mutate(Ch.Volume.mL = 650-volume_mL) %>% # hannah changed all this volume stuff to match my project
  mutate(Ch.Volume.L = Ch.Volume.mL * 0.001) %>% # mL to L conversion
  mutate(umol.sec = umol.L.sec*Ch.Volume.L) %>% #Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
  mutate_if(sapply(., is.character), as.factor) %>% #convert character columns to factors
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date_block= factor(date)) #make the blank column a factor

#View(RespoR2)
```


## Normalize to Blanks 
- things to consider here: try both ways 
- 1. average across all the days and get one point for each dilution 
- 2. keep it how it is - grouped by date_block (i think this is more correct)
```{r}
RespoR_Normalized_blankperday <- RespoR2 %>% 
  group_by(SGD_number, light_dark, date_block, new_colonynumber, site) %>% 
  filter(new_colonynumber== "BLANK") %>%
  summarise(umol.sec = mean(umol.sec, na.rm=TRUE)) %>% 
## so should have one value for each dilution 
  dplyr::select(blank.rate = umol.sec, site)


## two options: 1) summarise across all 4 days 2) direct comparison day to day 
## look at individual blank values to see if any of the days are particularly off - if everything looks consistent, can stick with individual days 
# take out date_block in group by and then change summarise function - to average all blanks by all dilutions 
# go back and check for blank volume to make sure full chamber vol 

### plot colonies against blanks ######
plot_Blank_Rates <- RespoR_Normalized_blankperday %>% 
  ggplot(aes(x=SGD_number, 
             y=blank.rate)) +
  scale_x_continuous(trans="log10") +
  geom_point() + 
  facet_wrap(site~date_block, scales="free_y")

plot_Blank_Rates2 <- RespoR_Normalized_blankperday %>% 
  #filter(date_block!="6/13/23") %>% 
  ggplot(aes(x=SGD_number, 
             y=blank.rate)) +
  scale_x_continuous(trans="log10") +
  geom_point() + 
  facet_wrap(site~light_dark, scales="free_y")

plot_Blank_Rates2.5 <- RespoR_Normalized_blankperday %>% 
  filter(date_block!="6/13/23") %>% 
  ggplot(aes(x=SGD_number, 
             y=blank.rate)) +
  scale_x_continuous(trans="log10") +
  geom_point() + 
  facet_wrap(site~light_dark, scales="free_y")

plot_Blank_Rates3 <- RespoR_Normalized_blankperday %>% 
  ggplot(aes(x=SGD_number, 
             y=blank.rate)) +
  scale_x_continuous(trans="log10") +
  geom_point() + 
  facet_wrap(date_block~light_dark, scales="free_y")


##### DELETE 6/13 FROM BLANK DATA FOR CABRAL 
RespoR_Normalized_blankperdaynoCabral <- RespoR_Normalized_blankperday %>% 
  filter(date_block!="6/13/23")

```

### Option 2 for Blanks - averaging  
```{r}

RespoR_Normalized_avgblanks <- RespoR2 %>% 
  group_by(SGD_number, light_dark, new_colonynumber, site) %>% 
  filter(new_colonynumber== "BLANK") %>%
  summarise(umol.sec = mean(umol.sec, na.rm=TRUE)) %>% 
## so should have one value for each dilution 
  dplyr::select(blank.rate = umol.sec, site)

### plot the averaged blanks to see if it is working properly ### 
plot_Blank_Rates_Averaged <- RespoR_Normalized_avgblanks %>% 
  ggplot(aes(x=SGD_number, 
             y=blank.rate)) +
  scale_x_continuous(trans="log10") +
  geom_point() + 
  facet_wrap(site~light_dark)

```

## Now combine into two dfs - one based on per day blank rates and the other based on averaged blank rates 
```{r}
#joining with per day blanks 
RespoR_Normalized_blankperday_joined <- RespoR_Normalized_blankperdaynoCabral %>% 
  ungroup() %>% 
  dplyr::select(SGD_number, light_dark, blank.rate, date_block, site) %>%
  right_join(RespoR2) %>% # join with the respo data
  mutate(umol.sec.corr = umol.sec - blank.rate, # subtract the blank rates from the raw rates
         umol.cm2.hr = (umol.sec.corr*3600)/SA_cm2, # convert to mmol g-1 hr-1
         umol.cm2.hr_uncorr = (umol.sec*3600)/SA_cm2) %>% 
  filter(new_colonynumber!="BLANK") %>% # remove the Blank data
  #ungroup() %>%
  dplyr::select(date, sample_ID, light_dark, SA_cm2, umol.cm2.hr, umol.sec, blank.rate, Temp.C, new_colonynumber, salinity, pH, site, SGD_number, umol.sec.corr, umol.cm2.hr_uncorr, phosphate_umolL, silicate_umolL, NN_umolL, ammonia_umolL)

#join with Tris pH data 
TrispH_RespoRNormalized_perdayBlanks <- RespoR_Normalized_blankperday_joined %>% 
  left_join(pHSlope)

```

### BASED ON WHAT BLANKS TO USE -  calculate R, GP, and NP 
- RIGHT NOW: using blanks per day

```{r}
# make the respiration values positive (pull out data for dark treatments)

RespoR_Normalized_dark <- TrispH_RespoRNormalized_perdayBlanks %>% 
  filter(light_dark == "DARK") %>% 
  mutate(umol.cm2.hr = umol.cm2.hr*-1,
         umol.cm2.hr_uncorr = umol.cm2.hr_uncorr*-1) %>% 
  mutate(umol.cm2.hr = ifelse(umol.cm2.hr < 0, 0, umol.cm2.hr),  # for any values below 0, make 0
         umol.cm2.hr_uncorr = ifelse(umol.cm2.hr_uncorr < 0, 0, umol.cm2.hr_uncorr)) %>% 
  mutate(P_R = "R") %>% # all dark run rates get R for respiration
  mutate(umol.cm2.hr = ifelse(umol.cm2.hr ==0, NA, umol.cm2.hr)) ####### DELETE THIS ONCE FIGURE OUT WHAT CABRAL 11/12 

# all light run rates get NP for net photosynthesis
RespoR_Normalized_light <- TrispH_RespoRNormalized_perdayBlanks %>% 
  filter(light_dark == "LIGHT") %>% 
  mutate(umol.cm2.hr = ifelse(umol.cm2.hr < 0, 0, umol.cm2.hr),  # for any values below 0, make 0
        umol.cm2.hr_uncorr = ifelse(umol.cm2.hr_uncorr < 0, 0, umol.cm2.hr_uncorr)) %>% 
  mutate(P_R = "NP") %>% 
  mutate(umol.cm2.hr = ifelse(umol.cm2.hr ==0, NA, umol.cm2.hr)) ####### DELETE THIS ONCE FIGURE OUT WHAT CABRAL 11/12 

# rejoin data into single df
RespoR_Normalized2 <- bind_rows(RespoR_Normalized_light, RespoR_Normalized_dark) %>% 
  drop_na(umol.cm2.hr) # removes C20 and C19 that were weird 


#make column for GP and group by fragment ID and salinity to keep R and NP together
RespoR_NormalizedGP <- RespoR_Normalized2 %>% 
  group_by(new_colonynumber, SGD_number, site, date, salinity, pH, phosphate_umolL, NN_umolL, ammonia_umolL, silicate_umolL) %>% ## EDITED FROM new_pH
  summarize(umol.cm2.hr = sum(umol.cm2.hr, na.rm=TRUE), 
            umol.cm2.hr_uncorr = sum(umol.cm2.hr_uncorr, na.rm=TRUE)) %>% # NP + R = GP
            #Temp.C = mean(Temp.C)) %>% 
  mutate(P_R="GP") %>% # Label for Gross Photosynthesis
  mutate(light_dark = "LIGHT") %>% 
  mutate(umol.cm2.hr = ifelse(umol.cm2.hr < 0, 0, umol.cm2.hr), # for any values below 0, make 0
         umol.cm2.hr_uncorr = ifelse(umol.cm2.hr_uncorr < 0, 0, umol.cm2.hr_uncorr))

# rejoin for full df with NP, R, and GP rates
RespoR_Normalized_Full <- RespoR_Normalized2 %>% 
  dplyr::select(new_colonynumber, pH, SGD_number, site, salinity, date, light_dark, P_R, umol.cm2.hr, umol.cm2.hr_uncorr, phosphate_umolL, silicate_umolL, NN_umolL, ammonia_umolL) %>%
  bind_rows(RespoR_NormalizedGP) %>% ## EDITED FROM NEW PH 
  mutate(umol.cm2.hr = ifelse(umol.cm2.hr ==0, NA, umol.cm2.hr))
 # filter(new_colonynumber!=20)


## what is wrong with Cabral 20? 
#Cabral20 <- RespoR_Normalized_Full %>%
 #filter(site=="Cabral") %>%
 # ggplot(aes(x=SGD_number, 
 #            y=umol.cm2.hr)) + 
 # facet_wrap(~new_colonynumber, scales = "free_y") +
#  geom_point() +
 # geom_smooth(method = "lm", se = FALSE) +
 # scale_x_continuous(trans="log10") 
  #labs(title="Respiration Normalized to Blanks for SGD Dils per colony")

write_csv(RespoR_Normalized_Full , here("Data","RespoFiles","Respo_RNormalized_AllRates.csv"))  

```


## testing plots for ph before and after corals were added 
- only have this data for Varari 

```{r}
##plot daytime pH 
ph_day <- TrispH_RespoRNormalized_perdayBlanks %>% 
  filter(site=="Varari") %>% 
  ggplot(aes(x=salinity, 
             y=new_pH))+
  geom_point(size=2) +
  #scale_color_manual(values=rev(pnw_palette("Sunset", n=14)) ,
                    # guide="none") +
  theme_bw() + 
  scale_x_reverse() +
  facet_wrap(~date) +
  #geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  labs(title = "daytime pH Varari") +
 theme(axis.text.x=element_text(size=15), 
        axis.text.y=element_text(size=15), 
        axis.title.x=element_text(size=15),
        axis.title.y=element_text(size=15), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=18)) 
ph_day

ph_night <- TrispH_RespoRNormalized_perdayBlanks %>% 
  filter(site=="Varari")%>% 
  drop_na() %>% 
  ggplot(aes(x=salinity, 
             y=pH_night))+
  geom_point(size=2) +
  #scale_color_manual(values=rev(pnw_palette("Sunset", n=14)) ,
                    # guide="none") +
  theme_bw() + 
  scale_x_reverse() +
  facet_wrap(~date) +
  #geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  labs(title = "night pH Varari") +
 theme(axis.text.x=element_text(size=15), 
        axis.text.y=element_text(size=15), 
        axis.title.x=element_text(size=15),
        axis.title.y=element_text(size=15), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=18)) 
ph_night


ph_day+ph_night


## for oen day of Cabral 
ph_day_C <- TrispH_RespoRNormalized_perdayBlanks %>% 
  filter(site=="Cabral") %>% 
  drop_na() %>% 
  ggplot(aes(x=salinity, 
             y=new_pH))+
  geom_point(size=2) +
  #scale_color_manual(values=rev(pnw_palette("Sunset", n=14)) ,
                    # guide="none") +
  theme_bw() + 
  scale_x_reverse() +
  #geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  labs(title = "daytime pH Cabral") +
 theme(axis.text.x=element_text(size=15), 
        axis.text.y=element_text(size=15), 
        axis.title.x=element_text(size=15),
        axis.title.y=element_text(size=15), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=18)) 
ph_day_C

## for one night of Cabral 

ph_night_Cabral <- TrispH_RespoRNormalized_perdayBlanks %>% 
  filter(site=="Cabral") %>% 
  drop_na() %>% 
  ggplot(aes(x=salinity, 
             y=pH_night))+
  geom_point(size=2) +
  #scale_color_manual(values=rev(pnw_palette("Sunset", n=14)) ,
                    # guide="none") +
  theme_bw() + 
  scale_x_reverse() +
  #geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  labs(title = "Cabral night pH") +
 theme(axis.text.x=element_text(size=15), 
        axis.text.y=element_text(size=15), 
        axis.title.x=element_text(size=15),
        axis.title.y=element_text(size=15), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=18)) 
ph_night_Cabral

ph_night_Cabral+ph_day_C


```


## Creating models to run stats - starting with Respiration 

```{r}
####################################
#### Respiration for SGD 
###################################

####### how to calculate variance ########
# The variance components are listed under "Random effects" in the (summary) output
# If we add up all the numbers in the Variance column, that is the total variance. 
# Then divide the variance of each factor by the total variance.
# This gives us the percent of variance explained by each source: 

#########################
### for Cabral 
RData_C <- RespoR_Normalized_Full %>% 
  filter(P_R == "R") %>% 
  filter(site=="Cabral") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date))

### HYPOTHESIS STATES NON LINEAR RELATIONSHIP 
polymodel_CabralResp <- lmer(data = RData_C, 
             umol.cm2.hr ~ poly(SGD_number, degree=2) + (1|date/new_colonynumber))

anova(polymodel_CabralResp) 
summary(polymodel_CabralResp)
check_model(polymodel_CabralResp)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "CabralRespirationpoly.jpg"), 
       width = 7, height = 10)

#### USE PERFORMANCE PACKAGE 
check_model(modelC_SGDbyR) ## does everything at once so you dont need qqp 
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "CabralRespiration.jpg"), 
       width = 7, height = 10)

anova(modelC_SGDbyR) 
summary(modelC_SGDbyR)
ranef(modelC_SGDbyR)



## this new package gives R-squared value for mixed models 
MuMIn::r.squaredGLMM(lme4::lmer(data = RData_C, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))
summary(lm(data = RData_C, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))$r.squared


###### trying to figure out error bars ###### 
## graphdata <- as.data.frame(emmeans(model2_SGDbyR, "SGD_number")) --> update: I don't think I need error bars on points, just general regression line ? 

###### example variance calculations #######
# for total variance  
0.00000002166 + 0.000002573 + 0.0000005112 ## equals 3.10586e-06
#for date 
0.000002573/0.00000310586 # equals 82% of variation 
#for newcolonynumber:date
0.00000002166/0.00000310586 ##explains 0.6% of the variation 


##### now plot ######
## Cabral respiration - original 
Respiration_SGD_C <- RespoR_Normalized_Full %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="R") %>% 
  mutate(salinity=as.factor(salinity)) %>% 
  ggplot(aes(x=SGD_number, 
             y=umol.cm2.hr, 
             color=salinity)) + 
  geom_point(size=4, 
             position = position_jitterdodge()) +
  scale_color_manual(values=rev(pnw_palette("Sunset2", n=14)) ,
                     guide="none") +
  theme_classic() + 
  #geom_smooth(method = "lm", se=TRUE, color="lightpink") + #### REMOVE GEOM SMOOTH BC INSIGNIFICANT 
  labs(x = "SGD Dilutions (% by volume)",
       color = "Salinity (ppt)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "Respiration Rates at Cabral") +
 theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
ggsave(here("Outputs", "WSNOutputs","Cabral_Resp.jpg"), 
       width = 10, height = 10)
Respiration_SGD_C



###### Cabral respiration  - now with emmeans #######
#Respiration_SGD_C2 <- graphdata %>% 
  #filter(site=="Cabral") %>% 
 # filter(P_R=="R") %>% 
  #ggplot(aes(x=SGD_number, 
          #   y=emmeans)) + 
  #geom_jitter(aes(color=SGD_number), position = position_jitterdodge()) + 
  #geom_errorbar(aes(ymax=emmean+SE, ymin=emmean-SE), color="black", stat="identity", position=position_dodge(width=0.9), width=0.1) +
  #theme_bw() + 
  #geom_smooth(method = "lm", se=FALSE, color="lightpink") +
  #labs(x = "SGD Dilutions (% by volume)",
       #color = "Salinity (ppt)",
       #y = "Rate (umol O2 cm2 hr-1)",
       #title = "Respiration for Cabral") 

#Respiration_SGD_C2

pnw_palette(name="Sunset2",n=14)

```

## Respiration Model and Plot for Varari 

```{r}
#######################
#### for Varari 
RData_V <- RespoR_Normalized_Full %>% 
  filter(P_R == "R") %>% 
  filter(site=="Varari") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
  filter(!is.infinite(umol.cm2.hr))

#### HYPOTHESIS ARE NON LINEAR MODELS 
polymodel_VarariResp <- lmer(data = RData_V, 
             umol.cm2.hr ~ poly(SGD_number, degree=2) + (1|date/new_colonynumber))

anova(polymodel_VarariResp) 
summary(polymodel_VarariResp)
check_model(polymodel_VarariResp)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "VarariRespirationpoly.jpg"), 
       width = 7, height = 10)


## date nested within random effect 
modelV_SGDbyR <- lmer(data = RData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber))

check_model(modelV_SGDbyR)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "VarariRespiration.jpg"), 
       width = 7, height = 10)

anova(modelV_SGDbyR) 
summary(modelV_SGDbyR)
#ranef(modelV_SGDbyR)
#AIC(model2_SGDbyR_V)

MuMIn::r.squaredGLMM(lme4::lmer(data = RData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))
summary(lm(data = RData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))$r.squared


#### now plot ######
Respiration_SGD_V <- RespoR_Normalized_Full %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  mutate(salinity=as.factor(salinity)) %>% 
  ggplot(aes(x=SGD_number, 
             y=umol.cm2.hr, 
             color=salinity)) + 
  geom_point(size=4, 
             position = position_jitterdodge()) +
  scale_color_manual(values=rev(pnw_palette("Sunset2", 16))) +
  theme_classic() + 
  labs(x = "SGD Dilutions (% by volume)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "Respiration for Varari") +
  #scale_x_continuous(limits=c(7.9,8.1)) +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
ggsave(here("Outputs", "WSNOutputs","Varari_Resp.jpg"), 
       width = 10, height = 10)
Respiration_SGD_V

```

### Models for GP data - Cabral 

```{r}
####################################
#### Gross Production for SGD 
###################################

### for Cabral 
GPData_C <- RespoR_Normalized_Full %>% 
  filter(P_R == "GP") %>% 
  filter(site=="Cabral") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
  filter(!is.infinite(umol.cm2.hr))

### 
polymodel_CabralGP <- lmer(data = GPData_C, 
             umol.cm2.hr ~ poly(SGD_number, degree=2) + (1|date/new_colonynumber))

anova(polymodel_CabralGP) 
summary(polymodel_CabralGP)
check_model(polymodel_CabralGP)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "CabralGPpoly.jpg"), 
       width = 7, height = 10)


## date nested within random effect of colony number 
modelC_SGDbyGP <- lmer(data = GPData_C, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber))

check_model(modelC_SGDbyGP)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "CabralGP.jpg"), 
       width = 7, height = 10)

anova(modelC_SGDbyGP) 
summary(modelC_SGDbyGP)
#ranef(modelC_SGDbyGP)

MuMIn::r.squaredGLMM(lme4::lmer(data = GPData_C, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))
summary(lm(data = GPData_C, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))$r.squared

## Cabral GP plot  
GP_SGD_C <- RespoR_Normalized_Full %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="GP") %>% 
  mutate(salinity=as.factor(salinity)) %>% 
  ggplot(aes(x=SGD_number, 
             y=umol.cm2.hr, 
             color=salinity)) + 
  geom_point(size=3, 
             position = position_jitterdodge()) +
  scale_color_manual(values=rev(pnw_palette("Sunset", n=16)), 
                     guide="none") +
  theme_bw() + 
  #geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  labs(x = "SGD Dilutions (% by volume)",
       color = "Salinity (ppt)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP for Cabral") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
ggsave(here("Outputs", "WSNOutputs","Cabral_GP.jpg"), 
       width = 10, height = 10)

GP_SGD_C


```

## GP for Varari 
```{r}
#######################
#### for Varari 
GPData_V <- RespoR_Normalized_Full %>% 
  filter(P_R == "GP") %>% 
  filter(site=="Varari") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
  filter(!is.infinite(umol.cm2.hr))
 # select(1,3:10) %>% 
  #drop_na()

#### HYP IS NON LINEAR 

polymodel_VarariGP <- lmer(data = GPData_V, 
             umol.cm2.hr ~ poly(SGD_number, degree=2) + (1|date/new_colonynumber))

anova(polymodel_VarariGP) 
summary(polymodel_VarariGP)
check_model(polymodel_VarariGP)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "VarariGPpoly.jpg"), 
       width = 7, height = 10)



## date nested within random effect 
modelV_SGDbyGP <- lmer(data = GPData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber))

check_model(modelV_SGDbyGP)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "VarariGP.jpg"), 
       width = 7, height = 10)

anova(modelV_SGDbyGP) 
summary(modelV_SGDbyGP)
#ranef(modelV_SGDbyGP)
#AIC(modelV_SGDbyGP)

MuMIn::r.squaredGLMM(lme4::lmer(data = GPData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))
summary(lm(data = GPData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))$r.squared

# plot GP and R separetly and then use patchwork to bring them together so that can include free scale y axes and linear regression lines  

## Varari Gross Production 
GP_SGD_V <- RespoR_Normalized_Full %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="GP") %>%
  mutate(salinity=as.factor(salinity)) %>% 
  ggplot(aes(x=SGD_number, 
             y=umol.cm2.hr)) + 
  geom_point(aes(color=salinity, show.legend=FALSE), 
             size=3, 
             position = position_jitterdodge()) +
  scale_color_manual(values=rev(pnw_palette("Sunset", n=16)), 
                     guide="none") +
  theme_bw() + 
 # geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  labs(x = "SGD Dilutions (% by volume)",
       color = "Salinity (ppt)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP for Varari") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
ggsave(here("Outputs", "WSNOutputs","Varari_GP.jpg"), 
       width = 10, height = 10)

GP_SGD_V


```


### Plotting results from models 
```{r}



```
## Calculating TA 
```{r}
calc.data <- read_csv(here("Data", "Titrations", "Calc_TArates.csv"))

######### create new data frame of just the initial data, pull out initial data from sample_type
initial <- calc.data %>% 
  filter(Sample_Collection == "Initial") %>% #tells you all the rows that you have with initial
  select("date","temp_C", "salinity_insitu", "TA") 

######## remove and create new data frame with just blanks
blanks <- calc.data %>% 
  filter(Sample_Type == "Blank")

calc.data <- calc.data %>% 
  filter(Sample_Collection == "Post")

names(initial)[3:6] <- paste0(names(initial)[3:6], "_initial") #use this to rename all of our columns

###### join blanks and carb chem data frame
calc.data <- left_join(calc.data, initial) #joing the initials to my data frame for carb chem
blanks <- left_join(blanks,initial)

###### figure out delta TA, initial-final
blanks_deltaTA <- blanks %>% 
  mutate(delta_TA_blank = TA_initial-TA)

####### getting the averages of blanks for each date and colony/treatment 
blanks_deltaTA <- blanks_deltaTA %>% 
  select(site, date, SGD_number, delta_TA_blank) %>% 
  group_by(date, site, SGD_number) %>% 
  summarise(mean.blanks=mean(delta_TA_blank))

calc.data <- left_join(calc.data, blanks_deltaTA)#bring in mean blanks to calc.data

######## need to join in SA,volume data and time data by fragment ID, before calculating NEC
sample.data <- read_csv(here("Data", "RespoFiles", "Fragment_MeasurementSampling_Cabral_Varari.csv")) #bring in SA and volume data sheet

SA <- sample.data[, c("sample_ID", "SA_cm2", "volume_mL")] #pull out the necessary columns and treatment 

SA2 <- SA %>%
 dplyr::mutate(light_dark = str_extract(sample_ID, "[^_]+$")) #split the sample_ID at the underscore to delete the Dark values

######## steps to organize and delete D values
rows.Dark <- which(SA2$light_dark == "Dark") #tells you all the rows that you have with blanks
Dark <-SA2[rows.Dark,] 
SA <- SA2[-rows.Dark,] #to remove the rows with dark data, now have data sheet with only light, SA and volume values
SA[,4] = NULL #had to delete the light-dark column to allow to just join by fragment.ID

calc.data2 <- left_join(calc.data, SA)

######## bring in the time data from resp.data sheet
resp.data <- read_csv(here("Data", "RespoFiles", "Respo_Metadata_SGDDilutions_Cabral_Varari.csv"))

######### need to organize and first delete the dark information
rows.dark2 <- which(resp.data$light_dark == "DARK") #tells you all the rows that you have with blanks
dark2 <-resp.data[rows.dark2 ,] 
resp.data <- resp.data[-rows.dark2,]

####### pull out columns that we want to use for our bind to the calc.data2 sheet
time.data <- resp.data[, c("sample_ID","SGD_dil", "start_time", "stop_time")] 
full.calc.data <- left_join(calc.data2, time.data)

######### NOW calculate the NEC rate
full.calc.data <- full.calc.data %>% 
  mutate(deltaTA = (TA_initial - TA) - mean.blanks) %>%  ### subtracted blank data 
  mutate(timediff = as.numeric(stop_time - start_time))

########## make a row that has rate.type for "C" assigned to light 
#full.calc.data$rate.type <-ifelse(full.calc.data$light_dark=='LIGHT', "C")
#view(full.calc.data)


########## equation to calculate NEC rates 
## time is in seconds 

full.calc.data <- full.calc.data %>% 
  mutate(deltaTA_2 = deltaTA/2,
         deltaTA_L = deltaTA_2*1.025, 
         umol.cm2.s = deltaTA_L*(.650-(volume_mL/1000))/(SA_cm2*timediff), 
         umol.cm2.hr = umol.cm2.s*3600) %>% 
  select(!c(deltaTA_2,deltaTA_L,umol.cm2.s))

full.calc.data2 <- full.calc.data %>% 
  filter(site=="Varari")

```

### Plot NEC for V and C 
```{r}
## now plot NEC by SGD - tried joining dfs 
#RespoR_Normalized_Full_joinedNEC <- full.calc.data
#  left_join(RespoR_Normalized_Full)
  
##############
## NEC for Cabral 

NEC_C <- full.calc.data %>%
  filter(site=="Cabral") %>% 
  filter(new_colonynumber!="20") %>% 
  filter(new_colonynumber!="BLANK") %>%
  mutate(salinity_insitu=as.factor(salinity_insitu)) %>% 
  ggplot(aes(x=SGD_number, 
             y=umol.cm2.hr, 
             color=salinity_insitu)) + 
  geom_point(size=4, 
             position = position_jitterdodge()) +
  scale_color_manual(values=rev(pnw_palette("Sunset2", n=16)), 
                     guide="none") +
  theme_classic() + 
 # facet_wrap(~new_colonynumber)+
  theme(strip.background = element_rect(fill = "white"))+
  #geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  geom_hline(yintercept = 0)+
  labs(x = "SGD Dilutions (% by volume)",
       color = "Salinity (ppt)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "Net Calcification Rates at Cabral") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
ggsave(here("Outputs", "WSNOutputs","Cabral_NEC.jpg"), 
       width = 10, height = 10)


NEC_C

full.calc.data2 <- full.calc.data %>% 
  filter(site=="Varari")

##############
## NEC for Varari 

NEC_V <- full.calc.data %>%
  filter(site=="Varari") %>% 
  filter(new_colonynumber!="BLANK") %>%
  mutate(salinity_insitu=as.factor(salinity_insitu)) %>% 
  ggplot(aes(x=SGD_number, 
             y=umol.cm2.hr, 
             color=salinity_insitu)) + 
  geom_point(size=4, 
             position = position_jitterdodge()) +
  scale_color_manual(values=rev(pnw_palette("Sunset2", n=16)), 
                     guide="none") +
  theme_classic() + 
  theme(strip.background = element_rect(fill = "white"))+
  geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  geom_hline(yintercept = 0)+
  labs(x = "SGD Dilutions (% by volume)",
       color = "Salinity (ppt)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "Net Calcification Rates at Varari") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
ggsave(here("Outputs", "WSNOutputs","Varari_NEC.jpg"), 
       width = 10, height = 10)

NEC_V

```

## Models for NEC 
```{r}

#### NEC for Cabral 
NECData_C <- full.calc.data %>% 
  filter(site=="Cabral") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  filter(new_colonynumber!="20") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) 

model_SGDbyNEC_C <- lmer(data = NECData_C, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber))

anova(model_SGDbyNEC_C) 
summary(model_SGDbyNEC_C)
ranef(model_SGDbyNEC_C)

check_model(model_SGDbyNEC_C)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "CabralNEC.jpg"), 
       width = 7, height = 10)

MuMIn::r.squaredGLMM(lme4::lmer(data = NECData_C, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))
summary(lm(data = NECData_C, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))$r.squared

## NEC for Varari 
NECData_V <- full.calc.data %>% 
  filter(site=="Varari") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
  filter(!is.infinite(umol.cm2.hr))

model_SGDbyNEC_V <- lmer(data = NECData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber))

anova(model_SGDbyNEC_V) 
summary(model_SGDbyNEC_V)
#ranef(model_SGDbyNEC_V)

check_model(model_SGDbyNEC_V)
ggsave(here("Outputs", "WSNOutputs","NormalityChecks", "VarariNEC.jpg"), 
       width = 7, height = 10)


MuMIn::r.squaredGLMM(lme4::lmer(data = NECData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))
summary(lm(data = NECData_V, 
             umol.cm2.hr ~ SGD_number + (1|date/new_colonynumber)))$r.squared

```

```{r}
RespoR_Normalized_Full_minV <- RespoR_Normalized_Full %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="NP")


RespoR_Normalized_Full_minV 

```











# NEW SECTION - started March 31st, 2024 


### EXAMPLE RESPIRATION PLOTS WITH SILICATE, AMMONIUM, N+N, PHOS + TA + pH 
```{r}
NNbyRplot <- Nutrient_Models %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
 # filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=NN_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=3) +
  theme_bw() + 
  labs(x = "Respiration Rates with N+N (umolL)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "N+N for Varari") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))

NNbyRplot

## Ammonium 
NH4byRplot <- Nutrient_Models %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
 # filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=ammonia_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=3) +
  theme_bw() + 
  labs(x = "Respiration Rates with NH4 (umolL)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "NH4 for Varari") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))

NH4byRplot

## Phosphate  
PhosbyRplot <- Nutrient_Models %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
 # filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=phosphate_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=3) +
  theme_bw() + 
  labs(x = "Respiration Rates with Phosphate (umolL)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "Phosphate for Varari") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
PhosbyRplot

### resp plots 

PhosbyRplot + NH4byRplot + NNbyRplot



###############################################
### try grouping by dilutions and day and plotting mean nutrients 
###############################################
Nutrient_Models <- RespoR_Normalized_Full %>% 
  filter(site=="Varari") %>% 
  drop_na(NN_umolL) %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr))
Nutrient_Models<-Nutrient_Models[-c(24),]  

Nutrient_Models_groupedavg <- Nutrient_Models %>% 
  group_by(date, SGD_number) %>% 
  summarize(meanN=mean(NN_umolL), 
            meanR=mean(umol.cm2.hr))


Nutrient_plots_groupedavg <- Nutrient_Models_groupedavg %>% 
  ggplot(aes(x=meanN, 
         y=meanR)) +
  geom_point(size=3) +
  theme_bw() + 
  labs(x = "mean N+N (umolL)",
       y = "mean Rate (umol O2 cm2 hr-1)",
       title = "mean rates for Varari") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))

Nutrient_plots_groupedavg


###########################################################

NNbyNPplot <- RespoR_Normalized_Full %>% 
# filter(site=="Varari") %>% 
  drop_na(NN_umolL) %>% 
  filter(P_R=="NP") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
 # filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=NN_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=3) +
  facet_wrap(date~site) +
  theme_bw() + 
  labs(x = "N+N (umolL)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "N+N for Varari") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))

NNbyNPplot




```

## GP PLOTS FOR NN, NH4, PO4, SILICATE  
```{r}
PhosphatesbyRplot <- RespoR_Normalized_Full %>% 
# filter(site=="Varari") %>% 
  drop_na(NN_umolL) %>% 
  filter(P_R=="R") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
 # filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=phosphate_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=3) +
  facet_wrap(date~site) +
  theme_bw() + 
  labs(x ="Phosphates (umolL)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "Phosphates per site")

PhosphatesbyRplot

PhosphatesbyNPplot <- RespoR_Normalized_Full %>% 
# filter(site=="Varari") %>% 
  drop_na(NN_umolL) %>% 
  filter(P_R=="NP") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) %>% 
 # filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=phosphate_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=3) +
  facet_wrap(~site) +
  theme_bw() + 
  labs(x ="Phosphates (umolL)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "Phosphates per site")

PhosphatesbyNPplot
```



# ASSOCIATED MODELS 
## RUNNING DIFFERENT MODELS WITH NUT DATA for RESPIRATION - only at VARARI!!! 
```{r}

#########################
### NN
##########################

####
Nutrient_Models_Varari <- RespoR_Normalized_Full %>% 
  filter(site=="Varari") %>% 
  drop_na(NN_umolL) %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr))
Nutrient_Models_Varari<-Nutrient_Models_Varari[-c(24),]  


## normal model with full nesting and random effects 
Varari_NN_resp <- lmer(data = Nutrient_Models, 
             umol.cm2.hr ~ poly(NN_umolL, degree=2) + (1|date/new_colonynumber))

anova(Varari_NN_resp) 
summary(Varari_NN_resp)

### without random effects 
Varari_NN_resp2 <- lm(data = Nutrient_Models, 
             umol.cm2.hr ~ poly(NN_umolL, degree=2))

anova(Varari_NN_resp2) 
summary(Varari_NN_resp2)


## just with colony number as random
Varari_NN_resp3 <- lmer(data = Nutrient_Models, 
             umol.cm2.hr ~ poly(NN_umolL, degree=2) + (1|new_colonynumber))

anova(Varari_NN_resp3) 
summary(Varari_NN_resp3)


####################################
## ammonia 
####################################

Varari_NH4_resp <- lmer(data = Nutrient_Models, 
             umol.cm2.hr ~ poly(ammonia_umolL, degree=2) + (1|date/new_colonynumber))

anova(Varari_NH4_resp) 
summary(Varari_NH4_resp)

## without random effects 
Varari_NH4_resp2 <- lm(data = Nutrient_Models, 
             umol.cm2.hr ~ poly(ammonia_umolL, degree=2))

anova(Varari_NH4_resp2) 
summary(Varari_NH4_resp2)


################################
### for pH 
#################################

Varari_pH_resp <- lmer(data = Nutrient_Models, 
             umol.cm2.hr ~ poly(pH, degree=2) + (1|date/new_colonynumber))






################################
### for TA 
#################################

## need to use calc.data sheet 
Varari <- full.calc.data %>% 
  filter(site=="Cabral") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  filter(new_colonynumber!="20") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) 




```

```{r}

##################################
#### starting with GP #### 
#################################




##### plots ############

GP_SGD_V <- RespoR_Normalized_Full %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="NP") %>%
  mutate(salinity=as.factor(salinity)) %>% 
  ggplot(aes(x=SGD_number, 
             y=umol.cm2.hr)) + 
  geom_point(aes(color=salinity, show.legend=FALSE), 
             size=3, 
             position = position_jitterdodge()) +
  scale_color_manual(values=rev(pnw_palette("Sunset", n=16)), 
                     guide="none") +
  theme_bw() + 
 # geom_smooth(method = "lm", se=TRUE, color="lightpink") +
  labs(x = "SGD Dilutions (% by volume)",
       color = "Salinity (ppt)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP for Varari") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 


GP_SGD_C <- RespoR_Normalized_Full %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="NP") %>% 
  filter(NN_umolL==)
  mutate(salinity=as.factor(salinity)) %>% 
  ggplot(aes(x=NN_umolL, 
             y=umol.cm2.hr, 
             color=salinity)) + 
  geom_point(size=3, 
             position = position_jitterdodge()) +
  scale_color_manual(values=rev(pnw_palette("Sunset", n=16)), 
                     guide="none") +
  theme_bw() + 
  labs(x = "Nitrates + Nitrites (umol/L)",
       color = "Salinity (ppt)",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP for Cabral") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
```


```{r}
#################################
## Calcification ## 
################################

##### models #######
NECData_C <- full.calc.data %>% 
  filter(site=="Cabral") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  filter(new_colonynumber!="20") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber), 
         date=as.factor(date)) 
```


#### 

