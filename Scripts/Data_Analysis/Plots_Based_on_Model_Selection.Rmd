---
title: "June 17th: Plots based on Model Selection for Environmental Parameters in SGD "
author: "Hannah Merges"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning=FALSE, 
                      message=FALSE)
```

### Loading libraries 
```{r, echo=FALSE}
library(LoLinR)
library(lubridate)
library(patchwork)
library(tidyverse)
library(here)
library(car)
library(GGally)
library(corrplot)
library(PNWColors)
library(seacarb)
library(broom)
library(agricolae)
library(lme4)
library(lmerTest)
library(modelsummary)
library(performance)
library(emmeans)
library(MuMIn)
library(broom.mixed)
library(kableExtra)
library(reshape2)
```

### Loading Data
```{r, echo=FALSE}
RespoR_Normalized_Full_withNEC_nutrients <- read_csv(here::here("Data", "RespoR_Normalized_Full_withNEC_andallnutrients.csv"))
```

### Plots for Gross Photosynthesis - Cabral: 
-  Cabral is significant for silicate at linear (0.04) and nonlinear (0.02)
-  Cabral is only significant for SGD Dils in the nonlinear model (0.02)
-  With removing an outlier point in the last dilution, Cabral is significant for GP both linear (0.015) and nonlinear (0.015)

```{r}
# mutate(ammonia_umolL = ifelse(ammonia_umolL = "<0.02", 0.01, ammonia_umolL)) %>% 

###################
## Silicate
####################

### confirm linear model 
GP_Cabral_silicate_linearmodel <- lmer(umol.cm2.hr ~ log(silicate_umolL+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Cabral_silicate_linearmodel)


### confirm nonlinear model 
GP_Cabral_silicate_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(silicate_umolL+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Cabral_silicate_nonlinearmodel)

#### both are significant so can add either trend line 

GP_Cabral_Silicate <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=silicate_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
 geom_smooth(method="lm", formula = "y~log(x)", color="black") +
 # geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log silicate",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP Rates for Cabral with Silicate") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
GP_Cabral_Silicate

###################
## SGD dils
####################

### confirm a linear model 
GP_Cabral_SGD_linearmodel <- lmer(umol.cm2.hr ~ log(SGD_number+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Cabral_SGD_linearmodel)


### confirm a nonlinear model 
GP_Cabral_SGD_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(SGD_number+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Cabral_SGD_nonlinearmodel)


GP_Cabral_SGDDils <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=SGD_number+1, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log SGD Dils",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP Rates for Cabral with SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
GP_Cabral_SGDDils

###################
## SGD dils WITHOUT POTENTIAL OUTLIERS
####################
GP_Cabral_SGDDils_nooutlier <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(sample_ID!= "Cabral_Col6_Dil9_Light") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=SGD_number+1, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
 scale_color_manual(values=pnw_palette("Bay", n=9)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  #geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
  geom_smooth(method="lm", formula = "y~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log SGD Dils",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP Rates for Cabral with SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
GP_Cabral_SGDDils_nooutlier

### confirm a linear model 
GP_Cabral_SGD_linearmodel_nooutlier <- lmer(umol.cm2.hr ~ log(SGD_number+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(sample_ID!= "Cabral_Col6_Dil9_Light") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Cabral_SGD_linearmodel_nooutlier)


### confirm a nonlinear model 
GP_Cabral_SGD_nonlinearmodel_nooutlier <- lmer(umol.cm2.hr ~ poly(log(SGD_number+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="GP") %>% 
  filter(sample_ID!= "Cabral_Col6_Dil9_Light") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Cabral_SGD_nonlinearmodel_nooutlier)

```

### Plots for Gross Photosynthesis - Varari 
-  Varari is ONLY significant for silicate in nonlinear model (0.02)
-  Varari has no significant relationship with SGD and GP 

```{r}
###################
## Silicate
####################

### confirm linear model 
GP_Varari_silicate_linearmodel <- lmer(umol.cm2.hr ~ log(silicate_umolL+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="GP") %>%
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Varari_silicate_linearmodel)


### confirm nonlinear model 
GP_Varari_silicate_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(silicate_umolL+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Varari_silicate_nonlinearmodel)

#### ONLY significant in nonlinear model 

GP_Varari_Silicate <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=silicate_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
 # geom_smooth(method="lm", formula = "y~log(x)", color="black") +
  geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log silicate",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP Rates for Varari with Silicate") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
GP_Varari_Silicate

###################
## SGD dils
####################

### confirm a linear model 
GP_Varari_SGD_linearmodel <- lmer(umol.cm2.hr ~ log(SGD_number+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Varari_SGD_linearmodel)


### confirm a nonlinear model 
GP_Varari_SGD_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(SGD_number+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(GP_Varari_SGD_nonlinearmodel)


GP_Varari_SGDDils <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="GP") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=SGD_number+1, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
#  geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log SGD Dils",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "GP Rates for Varari with SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
GP_Varari_SGDDils
```

### Plots for Respiration - Cabral: 
-  There is no significance at Cabral for any environmental parameter or broad SGD dilutions

```{r}
###################
## SGD dils
####################

### confirm a linear model 
R_Cabral_SGD_linearmodel <- lmer(umol.cm2.hr ~ log(SGD_number+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(R_Cabral_SGD_linearmodel)


### confirm a nonlinear model 
R_Cabral_SGD_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(SGD_number+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(R_Cabral_SGD_nonlinearmodel)


R_Cabral_SGDDils <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=SGD_number+1, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
 # geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log SGD Dils",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "R Rates for Cabral with SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
R_Cabral_SGDDils

```

### Plots for Respiration - Varari 
-  There is no significance at Varari for any environmental parameter or broad SGD dilutions 

```{r}

###################
## SGD dils
####################

### confirm a linear model 
R_Varari_SGD_linearmodel <- lmer(umol.cm2.hr ~ log(SGD_number+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(R_Varari_SGD_linearmodel)


### confirm a nonlinear model 
R_Varari_SGD_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(SGD_number+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(R_Varari_SGD_nonlinearmodel)


R_Varari_SGDDils <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="R") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=SGD_number+1, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
#  geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log SGD Dils",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "R Rates for Varari with SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
R_Varari_SGDDils
```

### Plots for Calcification - Cabral: 
-  Cabral was allegedly significant for temperature (0.01) and pH (0.01) with a nonlinear relationship  - but not seeing that here for temp, only for pH 
-  Cabral is NOT significant for SGD Dils 

```{r}
###################
## pH
####################

### confirm nonlinear model 
C_Cabral_pH_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(new_pH+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(C_Cabral_pH_nonlinearmodel)

C_Cabral_pH <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=new_pH, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
# geom_smooth(method="lm", formula = "y~log(x)", color="black") +
 geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log pH",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "C Rates for Cabral with pH") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
C_Cabral_pH

###################
## SGD dils
####################

### confirm a linear model 
C_Cabral_SGD_linearmodel <- lmer(umol.cm2.hr ~ log(SGD_number+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(C_Cabral_SGD_linearmodel)


### confirm a nonlinear model 
C_Cabral_SGD_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(SGD_number+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(C_Cabral_SGD_nonlinearmodel)


C_Cabral_SGDDils <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Cabral") %>% 
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=SGD_number+1, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  #geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log SGD Dils",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "C Rates for Cabral with SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
C_Cabral_SGDDils

```

### Plots for Calcification - Varari 
-  Varari has a significant linear and nonlinear relationship with phosphate (<0.0001) and (0.0002) and TA (0.001) 
-  Varari has a significant ... relationship with SGD 

```{r}
###################
## Phosphate
####################

### confirm nonlinear model 
C_Varari_phosphate_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(phosphate_umolL+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="C") %>% 
    filter(phosphate_umolL<1) %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(C_Varari_phosphate_nonlinearmodel)


C_Varari_Phosphate <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="C") %>% 
   filter(phosphate_umolL<1) %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=phosphate_umolL, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
 # geom_smooth(method="lm", formula = "y~log(x)", color="black") +
  geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "log phosphate",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "C Rates for Varari with Phosphate") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
C_Varari_Phosphate

###################
## TA 
####################

### confirm a nonlinear model 
C_Varari_SGD_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(TA_initial+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
    filter(TA_initial<2550) %>% #### IF CHOOSE TO REMOVE HIGH POINTS, ONLY SIGNIFICANT IN NONLINEAR (otherwise significant in linear too)
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(C_Varari_SGD_nonlinearmodel)


C_Varari_TA <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="C") %>% 
  # filter(TA_initial<2550) %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=TA_initial+1, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
 geom_smooth(method="lm", formula = "y~poly(log(x),2)", color="black") +
  geom_hline(yintercept = 0) +
  labs(x = "log TA",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "C Rates for Varari with TA (Minus the potential outliers)") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
C_Varari_TA



###################
## SGD dils
####################

### confirm a linear model 
C_Varari_SGD_linearmodel <- lmer(umol.cm2.hr ~ log(SGD_number+1) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>%
  filter(site=="Varari") %>% 
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(C_Varari_SGD_linearmodel)


### confirm a nonlinear model 
C_Varari_SGD_nonlinearmodel <- lmer(umol.cm2.hr ~ poly(log(SGD_number+1),2) + (1|new_colonynumber), data=RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>%
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)))

anova(C_Varari_SGD_nonlinearmodel)


C_Varari_SGDDils <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(site=="Varari") %>% 
  filter(P_R=="C") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=SGD_number+1, 
             y=umol.cm2.hr)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=9), 
                     guide="none") +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
geom_smooth(method="lm", formula = "y~log(x)", color="black") +
  geom_hline(yintercept = 0) +
  labs(x = "log SGD Dils",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "NEC Rates for Varari with SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
C_Varari_SGDDils
```

### Plot nutrient levels with SGD dils to see how different the nutrients actually are across the dilutions 

```{r, echo=FALSE}

#######################
### NN
#######################
Nitrate_Levels_per_SGDDil <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  ggplot(aes(x=SGD_number+1, 
             y=NN_umolL)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=14)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~site, scales = "free_y") +
  geom_smooth(method="lm", formula="y~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "SGD Dils",
       y = "NN",
       title = "NN levels per SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
Nitrate_Levels_per_SGDDil

#######################
### Phosphate
#######################

Phosphate_Levels_per_SGDDil <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(phosphate_umolL<1) %>% 
  ggplot(aes(x=SGD_number+1, 
             y=phosphate_umolL)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=14)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~site, scales = "free_y") +
 geom_smooth(method="lm", formula="(y)~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "SGD Dils",
       y = "Phosphate",
       title = "Phosphate levels per SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
Phosphate_Levels_per_SGDDil


#######################
### Silicate
#######################

Silicate_Levels_per_SGDDil <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  ggplot(aes(x=SGD_number+1, 
             y=silicate_umolL)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=14)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~site, scales = "free_y") +
 geom_smooth(method="lm", formula="(y)~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "SGD Dils",
       y = "Silicate",
       title = "Silicate levels per SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
Silicate_Levels_per_SGDDil

#######################
### Ammonia
#######################

Ammonia_Levels_per_SGDDil <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  ggplot(aes(x=SGD_number+1, 
             y=ammonia_umolL)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=14)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~site, scales = "free_y") +
 geom_smooth(method="lm", formula="(y)~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "SGD Dils",
       y = "Ammonia",
       title = "Ammonia levels per SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
Ammonia_Levels_per_SGDDil

#######################
### Salinity
#######################

Salinity_Levels_per_SGDDil <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  ggplot(aes(x=SGD_number+1, 
             y=salinity)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=14)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~site, scales = "free_y") +
 geom_smooth(method="lm", formula="(y)~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "SGD Dils",
       y = "Salinity",
       title = "Salinity levels per SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
Salinity_Levels_per_SGDDil

#######################
### pH
#######################

pH_Levels_per_SGDDil <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  ggplot(aes(x=SGD_number+1, 
             y=new_pH)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=14)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~site, scales = "free_y") +
 geom_smooth(method="lm", formula="(y)~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "SGD Dils",
       y = "pH",
       title = "pH levels per SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
pH_Levels_per_SGDDil

#######################
### temp
#######################

temp_Levels_per_SGDDil <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  ggplot(aes(x=SGD_number+1, 
             y=temp_C)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=14)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~site, scales = "free_y") +
 geom_smooth(method="lm", formula="(y)~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "SGD Dils",
       y = "temp",
       title = "temp levels per SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
temp_Levels_per_SGDDil

#######################
### TA
#######################

TA_Levels_per_SGDDil <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  ggplot(aes(x=SGD_number+1, 
             y=TA_initial)) + 
  geom_point(size=4, aes(color=as.factor(new_colonynumber))) +
  scale_color_manual(values=pnw_palette("Bay", n=14)) +
  theme_bw() + 
  coord_trans(x ="log") +
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~site, scales = "free_y") +
 geom_smooth(method="lm", formula="(y)~log(x)", color="black") +
 # geom_hline(yintercept = 0) +
  labs(x = "SGD Dils",
       y = "TA",
       title = "TA levels per SGD Dils") +
   theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
TA_Levels_per_SGDDil
```

### Plot how many corals are dead vs alive 

```{r}

Net_CalcvsDissolution <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(P_R=="C") %>% 
  mutate(SGD_number = as.character(SGD_number), 
         rate_category = ifelse(umol.cm2.hr > 0, "positive", "negative")) %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  ggplot(aes(x=SGD_number, 
             y=umol.cm2.hr,
             fill=rate_category)) + 
  geom_col(width = 0.8,  colour = NA) + 
  #scale_fill_manual(values =  ifelse (umol.cm2.hr > 0, "red", "black")) +
  scale_fill_manual(values=c(positive='black',negative='red')) +
  theme_bw() + 
  geom_hline(yintercept = 0) +
  facet_wrap(~site) +
 #coord_trans(x ="log") +
  labs(x = "SGD values",
       y = "Rate (umol O2 cm2 hr-1)",
       title = "Net Calcifying vs Net Dissolving Corals per SGD Dilution") +
   theme(axis.text.x=element_text(size=14), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
Net_CalcvsDissolution

```

### Plot GP:R as a function of SGD 
-  Cabral is significant (0.025) but Varari is not 
```{r}
## First make new df
GP_RRatio_bySGDDils <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  dplyr::select(!"sample_ID") %>% 
  filter(!is.infinite(umol.cm2.hr)) %>% 
  group_by(P_R, SGD_number, date, site, new_colonynumber) %>% 
  filter(P_R!="C", P_R!="NP") %>% 
  #summarize(GP_R = GP/R)
  pivot_wider(names_from = P_R, values_from = umol.cm2.hr) %>% 
  mutate(GP_R = GP/R) 

### plots 
GP_R_bySGD_bothsites <- GP_RRatio_bySGDDils %>% 
  #filter(site=="Varari") %>% 
  mutate(new_colonynumber= as.factor(new_colonynumber)) %>% 
  ggplot(aes(x=(SGD_number+1), 
             y=GP_R)) + 
  geom_point(size=3, aes(color=new_colonynumber)) +
  theme_bw() + 
  coord_trans(x="log") +
  facet_wrap(~site, scales = "free_y") +
  geom_smooth(method="lm", formula = "y~log(x)") +
  labs(x = "SGD Dilutions",
       y = "Gross Photosynthesis/Respiration Rates",
       title = "SGD by GP:R Relationship for Varari") +
   theme(axis.text.x=element_text(size=12), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20))
GP_R_bySGD_bothsites

## model testing 
model_GP_R_SGD_Varari <- lmer(GP_R ~ log(SGD_number+1) + (1|new_colonynumber), data = GP_RRatio_bySGDDils %>%
                                        filter(site=="Varari"))
anova(model_GP_R_SGD_Varari)

model_GP_R_SGD_Cabral <- lmer(GP_R ~ log(SGD_number+1) + (1|new_colonynumber), data = GP_RRatio_bySGDDils %>%
                                        filter(site=="Cabral"))
anova(model_GP_R_SGD_Cabral)

```

### Make correlation matrix for nutrients 

```{r}
## data 
corr_matrix_envparams <- RespoR_Normalized_Full_withNEC_nutrients %>% 
  filter(P_R=="R") %>% 
  mutate(Salinity=salinity) %>% 
  select(!c("salinity", "umol.cm2.hr", "SGD_number", "new_colonynumber", "sample_ID", "site", "date", "P_R", "ammonia_umolL")) ## removed ammonia for rn because have less than values and causing NAs

##visualize it 
ggcorr(corr_matrix_envparams, method = c("everything", "pearson")) 

###############################
### Dani B's methods #######
cor_mat <- round(cor(corr_matrix_envparams),4)
head(cor_mat)

#melt the correlation matrix means it reassembles data frame to be more effective to complete corr matrix
#to long format
melted_cormat <- melt(cor_mat)
head(melted_cormat)

#visulaize the correlation matrix in general
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()

# Get lower and upper triangle of the correlation matrix
#Note that, a correlation matrix has redundant information. We’ll use the functions below to set half of it to NA
get_lower_tri<-function(cor_mat){
  cormat[upper.tri(cor_mat)] <- NA
  return(cor_mat)
}
# Get upper triangle of the correlation matrix
get_upper_tri <- function(cor_mat){
  cor_mat[lower.tri(cor_mat)]<- NA
  return(cor_mat)
}

#apply upper tri calculation to graphc
upper_tri <- get_upper_tri(cor_mat)
upper_tri

#melt the correlation matrix
#melt the correlation data and drop the rows with NA values 
melted_cormat <- melt(upper_tri, na.rm = TRUE)

#heatmap of correlation matrix
#negative correlations are in purple color and positive correlations in red
#scale_fill_gradient2 is used with the argument limit = c(-1,1) as correlation coefficients range from -1 to 1
#coord_fixed() : this function ensures that one unit on the x-axis is the same length as one unit on the y-axis
ggplot(data = melted_cormat, aes(Var2, Var1, fill = value))+
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "midnightblue", high = "firebrick4", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1))+
  coord_fixed()

melted_cormat <- melted_cormat %>% mutate_at(vars(starts_with("value")), funs(round(., 2)))

# Create a ggheatmap with basic characteristics, etc. 
ggheatmap <- ggplot(melted_cormat, aes(Var2, Var1, fill = value))+
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "firebrick3", mid = "white", high = "dodgerblue3", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1))+
  coord_fixed()


# Print the heatmap
print(ggheatmap)

#add correlation coefficients to the heatmap
#geom_text() to add the correlation coefficients on the graph
#guides() to change the position of the legend title
#if else statement in melted data frame to quotes of black and white to adjust text color 
corr_matrix_SGD_params <- ggheatmap + 
  geom_text(aes(Var2, Var1, label = value), color = "black", size = 6) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 18, face="bold", color="black"),
        axis.text.y = element_text(size = 18, face="bold", color="black"),
        panel.grid.major = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        legend.justification = c(0.8, 0),
        legend.title = element_text(size = 18, face="bold", color="black"),
        legend.text = element_text(size = 20, face="bold", color="black"),
        legend.position = c(0.48, 0.75),
        legend.direction = "horizontal") +
  guides(fill = guide_colorbar(barwidth = 12, barheight = 2, 
                               title.position = "top", title.hjust = 0.5, title.vjust = 1.0))

corr_matrix_SGD_params

```

### Results of back calculating 
```{r}

```


